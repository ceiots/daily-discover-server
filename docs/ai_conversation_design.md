# AI对话功能表结构设计文档

## 设计原则

- 每表字段控制在20个以内，避免使用外键约束
- 兼顾业务功能完整性与SQL查询性能
- 针对高并发、高可用和高性能场景进行优化设计
- 采用合理的索引策略提升查询效率
- 字段类型选择合理，节省存储空间

## 核心表结构说明

### 1. AI对话会话表 (ai_conversation)

**表用途**：记录用户与AI的对话会话基本信息，是整个对话系统的核心表。

**主要字段**：
- `id`: 会话唯一标识
- `user_id`: 用户ID，关联用户
- `conversation_title`: 会话标题
- `conversation_type`: 会话类型(普通对话/内容创作/问题解答/商品咨询)
- `model_id`: 使用的模型标识
- `context_length`: 上下文长度
- `total_tokens`: 累计消耗的token
- `status`: 会话状态(进行中/已结束/异常中断)
- `is_pinned`: 是否置顶

**优化考虑**：
- 为用户ID和状态创建联合索引，加速用户会话列表查询
- 为创建时间和最后消息时间创建索引，支持时间排序
- 为置顶状态创建组合索引，优化置顶会话查询

### 2. AI对话消息表 (ai_message)

**表用途**：存储会话中的具体消息内容，包括用户输入和AI回复。

**主要字段**：
- `id`: 消息唯一标识
- `conversation_id`: 关联的会话ID
- `message_index`: 消息在会话中的序号
- `role`: 角色(用户/AI/系统)
- `content`: 消息内容
- `content_type`: 内容类型(文本/图片/音频/视频/文件)
- `token_count`: 消息token数
- `duration_ms`: 处理耗时
- `feedback_type`: 反馈类型(点赞/点踩/举报)

**优化考虑**：
- 为会话ID和消息序号创建联合索引，支持会话内消息按序获取
- 将大字段`content`设为text类型，适合存储长文本
- 使用JSON类型字段存储媒体文件URL，灵活支持多种媒体

### 3. AI模型配置表 (ai_model)

**表用途**：管理系统支持的AI模型配置信息。

**主要字段**：
- `model_code`: 模型标识码
- `model_name`: 模型名称
- `model_version`: 模型版本
- `provider`: 服务提供商
- `api_endpoint`: API端点
- `max_token_limit`: 最大token限制
- `input_price`/`output_price`: 输入/输出价格
- `capabilities`: 能力标签(JSON)

**优化考虑**：
- 为模型标识码和版本创建唯一索引，避免重复配置
- 使用JSON类型存储模型能力标签和默认参数，提供灵活扩展

### 4. AI知识库相关表

**知识库表(ai_knowledge_base)**：
- 存储知识库基本信息，包括名称、拥有者、访问权限等

**知识库文档表(ai_knowledge_document)**：
- 存储上传到知识库的文档信息
- 记录文档类型、文件大小、向量化状态等

**知识库文档块表(ai_knowledge_chunk)**：
- 存储文档分块后的内容片段
- 记录每个块的向量表示，用于相似度检索

**优化考虑**：
- 将文档内容分块存储，便于向量检索
- 使用`content_hash`进行文档去重
- 向量数据使用mediumtext类型存储，支持大容量向量

### 5. 统计和配额表

**AI对话统计表(ai_conversation_stats)**：
- 记录用户每日/每月的对话统计数据
- 包括对话次数、消息数、token消耗等

**AI用户配额表(ai_user_quota)**：
- 管理用户使用AI的额度限制
- 支持多种配额类型和周期设置

**优化考虑**：
- 按日期和用户ID分表存储统计数据，提升写入性能
- 为配额相关字段创建合适索引，加速配额校验

### 6. 其他功能表

**AI对话模板表(ai_conversation_template)**：
- 存储预设的对话模板，如不同场景的对话引导

**AI工具表(ai_tool)及调用记录表(ai_tool_usage)**：
- 管理AI可调用的外部工具/插件
- 记录工具调用历史

**AI对话标签表(ai_conversation_tag)及关联表**：
- 支持用户对会话进行标签分类

**AI系统提示词表(ai_system_prompt)**：
- 存储系统级别的提示词模板

## 性能优化设计

1. **分表策略**：
   - 消息表考虑按会话ID进行分表，避免单表过大
   - 统计数据按时间维度进行分表，提高写入效率

2. **索引优化**：
   - 为高频查询条件创建合适索引
   - 使用联合索引减少索引数量
   - 避免过多索引影响写入性能

3. **字段类型优化**：
   - 使用合适的字段类型和长度
   - 大文本内容使用text类型
   - 结构化数据使用JSON类型，提供灵活性

4. **无外键设计**：
   - 避免使用外键约束，由应用层保证数据一致性
   - 减少锁竞争，提高并发性能

5. **高频查询优化**：
   - 会话列表查询优化：使用(user_id, is_pinned, create_time)组合索引
   - 消息历史查询优化：使用(conversation_id, message_index)组合索引
   - 知识库检索优化：向量数据独立存储，便于向量相似度搜索

6. **水平扩展设计**：
   - 表结构设计支持分库分表
   - 可按用户ID进行分片，支持水平扩展

## 存储空间优化

1. 大文本数据独立存储，主表只存储元数据
2. 向量数据使用高效编码方式存储
3. 历史消息可考虑定期归档，减轻主表负担

## 后续优化方向

1. 考虑使用分布式存储系统存储大容量向量数据
2. 引入缓存层减轻数据库压力，如Redis缓存热门会话
3. 对长期不活跃的会话数据进行冷热分离存储 