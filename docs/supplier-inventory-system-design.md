# 供应商与库存系统设计说明

## 一、总体设计原则

设计供应商与库存系统时，我们遵循以下原则：

1. **业务流程完整性**：支持采购、入库、出库、盘点等核心业务流程
2. **数据一致性**：保证库存数据的准确性和一致性
3. **高性能查询**：针对高频查询场景优化索引设计
4. **表结构轻量化**：控制每个表的字段数量，保持在20个以内
5. **避免外键约束**：使用逻辑外键而非物理外键，提高性能
6. **最小可行性**：确保满足基本业务需求的同时不过度设计

## 二、核心表结构设计

### 1. 供应商管理

#### supplier（供应商表）
- 存储供应商基本信息
- 使用 `status` 状态字段支持供应商启用/禁用管理
- 索引优化：按名称和状态查询

#### supplier_product（供应商产品关联表）
- 维护供应商与产品的多对多关系
- 记录成本价、最小订购量、交货周期等采购关键信息
- 支持一个产品有多个供应商，并可标记主要供应商
- 复合唯一索引确保一个供应商对一个产品只有一条记录

### 2. 库存管理

#### inventory（库存主表）
- 采用"可用库存+锁定库存"设计模式，支持库存锁定机制
- 添加版本号支持乐观锁并发控制
- 复合唯一索引确保一个产品在一个店铺只有一条库存记录
- 复合索引优化库存预警查询

#### inventory_log（库存日志表）
- 记录所有库存变动，支持完整的库存追溯
- 支持多种日志类型：入库、出库、锁定、解锁
- 关联订单和采购单，支持业务关联查询
- 多个索引支持各种维度的日志查询

### 3. 采购管理

#### purchase_order（采购单主表）
- 记录采购单基本信息和状态
- 支持完整的采购状态流转：待确认→已确认→部分入库→全部入库
- 乐观锁支持并发控制

#### purchase_order_item（采购单明细表）
- 存储采购单商品明细
- 记录采购数量和已入库数量，支持部分入库场景
- 包含订单号字段，支持不通过ID关联的查询

### 4. 入库管理

#### purchase_receipt（采购入库表）
- 支持采购单到入库单的转化
- 支持部分入库和全部入库场景
- 记录入库操作人和时间，满足审计需求

#### purchase_receipt_item（采购入库明细表）
- 记录入库商品明细
- 对比预期数量和实际入库数量，支持异常处理
- 完整的关联索引支持多维度查询

### 5. 库存管理扩展

#### inventory_check（库存盘点表）
- 支持库存盘点业务流程
- 记录盘点状态和操作人信息
- 丰富的时间字段支持盘点周期管理

#### inventory_check_item（库存盘点明细表）
- 记录每个商品的盘点结果
- 对比系统库存和实际库存，计算差异
- 支持按差异大小查询，优先处理问题商品

#### inventory_alert（库存预警记录表）
- 记录库存低于阈值的预警信息
- 支持预警处理流程：未处理→已处理/已忽略
- 记录处理人和处理备注，支持预警跟踪

## 三、业务流程支持

### 1. 采购入库流程
1. 创建采购单（purchase_order + purchase_order_item）
2. 供应商确认采购单（更新purchase_order.status）
3. 商品到货，创建入库单（purchase_receipt + purchase_receipt_item）
4. 确认入库，更新库存（更新inventory表，增加可用库存）
5. 记录库存变动日志（插入inventory_log）
6. 更新采购单状态（更新purchase_order.status）

### 2. 订单出库流程
1. 用户下单，锁定库存（减少inventory.available_quantity，增加inventory.locked_quantity）
2. 记录锁定日志（插入inventory_log，log_type=3）
3. 订单支付成功，确认出库（减少inventory.locked_quantity）
4. 记录出库日志（插入inventory_log，log_type=2）
5. 订单取消，解锁库存（减少inventory.locked_quantity，增加inventory.available_quantity）
6. 记录解锁日志（插入inventory_log，log_type=4）

### 3. 库存盘点流程
1. 创建盘点单（inventory_check）
2. 录入盘点明细（inventory_check_item）
3. 确认盘点结果，如有差异调整库存（更新inventory）
4. 记录库存调整日志（插入inventory_log）
5. 完成盘点（更新inventory_check.status）

### 4. 库存预警流程
1. 系统定时检查库存，发现低于阈值记录预警（inventory_alert）
2. 管理员处理预警，创建采购单（关联purchase_order）
3. 更新预警状态（更新inventory_alert.alert_status）

## 四、性能优化设计

### 1. 索引优化
- 为所有主键ID创建索引
- 为业务编号（如订单号、入库单号）创建索引
- 为状态字段创建索引，优化状态筛选查询
- 为时间字段创建索引，支持时间范围查询
- 使用复合索引优化多条件查询

### 2. 表结构优化
- 控制字段数量，保持表轻量化
- 合理选择字段类型和长度
- 使用tinyint存储状态码，减少存储空间
- 使用乐观锁控制并发，避免悲观锁
- 不使用物理外键，减少锁争用

### 3. 查询性能考虑
- 添加冗余字段（如订单号），减少表连接查询
- 为高频组合查询条件创建复合索引
- 使用创建时间索引支持分页查询
- 库存日志表考虑按时间分区，提高大数据量查询性能

## 五、扩展性考虑

该设计为最小可行版本，后续可以根据业务需求扩展：

1. 添加供应商评级和评价功能
2. 扩展采购申请和审批流程
3. 增加库存分仓管理
4. 添加库存周转率分析
5. 支持供应商对账和结算

## 六、数据一致性保障

1. 使用事务确保库存变更的原子性
2. 版本号字段支持乐观锁并发控制
3. 完整的日志记录支持数据追溯和校验
4. 定期盘点机制发现并修正不一致

以上设计满足供应商和库存管理的最小可行功能，在业务正确性和SQL性能之间取得了良好平衡。 