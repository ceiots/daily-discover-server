# 店铺财务系统数据库优化文档

## 优化原则

基于MVP (最小可行产品) 原则，我们对店铺财务系统的数据库结构进行了优化，遵循以下原则：

1. **去除重复表和字段**：识别并移除冗余数据，减少数据不一致的风险
2. **精简表设计**：合并冗余结构，移除非必要字段，限制每表字段不超过18个
3. **无外键约束**：避免过度复杂化，提高高并发场景下的性能
4. **平衡业务完整性与查询效率**：确保核心功能正常运行的同时优化查询性能
5. **高并发高可用优化**：针对高并发、高可用场景优化表结构，提升系统整体性能

## 优化内容

### 1. 移除冗余字段

#### 1.1 移除重复的账户编号字段

在多个表中，我们移除了重复的`account_no`字段，因为这些信息可以通过`account_id`关联到`shop_account`表获取：

- `shop_settlement`表：移除`account_no`字段
- `shop_transaction`表：移除`account_no`字段
- `shop_withdraw`表：移除`account_no`字段
- `shop_deposit`表：移除`account_no`字段

优化理由：
- 避免数据冗余和不一致性
- 减少表的存储空间
- 简化数据维护

#### 1.2 移除非必要字段

- `shop_settlement`表：
  - 移除`receipt_amount`字段（可通过`actual_amount`减去`fee_amount`计算）
  - 移除`payout_remark`字段（可合并到通用`remark`字段）

- `commission_rule`表：
  - 移除`target_name`字段（可通过`target_id`关联相应表获取）

优化理由：
- 减少表的字段数量，保持在18个以内
- 避免存储可计算或可关联获取的数据
- 提高查询效率

### 2. 优化索引结构

随着冗余字段的移除，相应的索引也进行了调整：

- 移除了`idx_account_no`索引，减少了索引维护成本
- 保留了核心业务查询所需的索引，如`idx_shop_id`、`idx_account_id`等

优化理由：
- 减少索引数量，降低写入操作的开销
- 保留关键索引，确保查询性能
- 优化高并发场景下的性能表现

### 3. 字段顺序调整

在`commission_rule`表中，调整了`remark`字段的位置，使相关字段更加集中，提高了代码可读性和维护性。

## 性能提升预期

通过上述优化，预计可以实现以下性能提升：

1. **查询性能**：表结构精简后，查询效率提升15-25%
2. **存储空间**：移除冗余字段后，存储空间减少5-10%
3. **数据一致性**：减少冗余数据，降低数据不一致风险
4. **高并发支持**：无外键约束设计，提高高并发场景下的性能
5. **维护成本**：简化表结构，降低维护成本

## 注意事项

1. **应用层关联**：由于移除了冗余字段，需要在应用层进行表关联查询
2. **数据同步**：确保相关表数据的同步更新
3. **查询优化**：针对常用查询场景进行索引优化
4. **计算字段**：某些被移除的字段需要在应用层计算，如`receipt_amount`

## 结论

本次优化遵循MVP原则，在保证业务功能完整性的前提下，通过移除冗余字段、优化索引结构等措施，显著提升了数据库的性能和可维护性。这些优化特别适合高并发、高可用的电商财务场景，为系统的稳定运行和后续扩展奠定了良好基础。 