# 跨域配置说明

## 概述

本文档详细说明每日发现项目中跨域资源共享（CORS）的配置和使用方法。

## 配置文件

### WebMvcConfig.java

**位置**: `com.dailydiscover.common.config.WebMvcConfig`

**功能**: 统一配置所有微服务的CORS跨域支持

### 配置详情

```java
@Configuration
@ConditionalOnProperty(name = "daily-discover.common.mode", havingValue = "library")
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

## 配置参数说明

| 参数 | 值 | 说明 |
|------|-----|------|
| `allowedOriginPatterns` | `*` | 允许所有来源的跨域请求 |
| `allowedMethods` | 所有HTTP方法 | 支持GET、POST、PUT、DELETE、OPTIONS、PATCH |
| `allowedHeaders` | `*` | 允许所有请求头 |
| `allowCredentials` | `true` | 允许携带凭据（如Cookie） |
| `maxAge` | `3600` | 预检请求缓存时间（秒） |

## 工作原理

### 1. 条件配置
- 使用`@ConditionalOnProperty`注解
- 仅在`daily-discover.common.mode=library`时生效
- 避免与独立服务模式冲突

### 2. 自动加载
- 应用服务通过`scanBasePackages`扫描`com.dailydiscover.common`包
- 自动加载CORS配置
- 所有接口自动支持跨域

### 3. 预检请求处理
- 浏览器发送OPTIONS预检请求
- 服务器返回正确的CORS头信息
- 后续实际请求正常处理

## 应用服务配置

### 1. 依赖配置
在应用服务的`pom.xml`中添加依赖：

```xml
<dependency>
    <groupId>com.dailydiscover</groupId>
    <artifactId>daily-discover-common</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 2. 包扫描配置
在应用启动类中添加包扫描：

```java
@SpringBootApplication(scanBasePackages = {
    "com.dailydiscover.user", 
    "com.dailydiscover.common"
})
```

### 3. 模式配置
在`application.yml`中设置：

```yaml
daily-discover:
  common:
    mode: library
```

## 常见问题

### 1. 为什么需要CORS配置？
- 浏览器安全策略限制跨域请求
- 需要服务器明确授权才能跨域访问
- 避免CSRF攻击等安全问题

### 2. 预检请求（OPTIONS）的作用？
- 浏览器在实际请求前发送OPTIONS请求
- 检查服务器是否支持跨域
- 获取允许的HTTP方法和头信息

### 3. 配置不生效的可能原因？
- 模式配置错误（应为`library`）
- 包扫描路径未包含`com.dailydiscover.common`
- 与其他CORS配置冲突

## 最佳实践

### 1. 生产环境配置
```java
// 限制特定域名
.allowedOriginPatterns(
    "https://*.dailydiscover.com",
    "https://*.dailydiscover.cn"
)
```

### 2. 安全配置
```java
// 限制允许的头信息
.allowedHeaders(
    "Content-Type", 
    "Authorization", 
    "X-Requested-With"
)
```

### 3. 性能优化
```java
// 适当调整预检缓存时间
.maxAge(1800) // 30分钟
```

## 相关文件

- `WebMvcConfig.java` - 主要配置类
- `application.yml` - 模式配置
- 各应用服务的启动类 - 包扫描配置

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-12-26 | 初始版本，统一CORS配置 |

## 技术支持

如有问题，请联系开发团队或查看相关日志文件。