# API日志功能使用说明

## 概述

简化版API日志系统提供统一的API调用日志记录功能，通过AOP自动拦截Controller方法，记录请求、响应、执行时间和异常信息。

## 核心组件

### 1. ApiLogger (核心日志记录器)
- **位置**: `com.dailydiscover.common.util.ApiLogger`
- **功能**: 提供统一的日志格式和输出
- **特性**:
  - 统一的日志格式：`API调用 | 接口描述 | 时间戳 | URL | 方法 | 客户端 | 状态 | 耗时`
  - 支持成功和异常两种日志类型
  - 自动获取客户端IP地址

### 2. ApiLogAspect (AOP切面)
- **位置**: `com.dailydiscover.common.aspect.ApiLogAspect`
- **功能**: 自动拦截Controller方法并记录日志
- **拦截范围**:
  - 所有标记了`@ApiLog`注解的方法
  - 所有Controller包下的方法（`com.dailydiscover..controller..*.*(..)`）

### 3. ApiLogConfig (配置类)
- **位置**: `com.dailydiscover.common.config.ApiLogConfig`
- **功能**: 提供灵活的日志配置选项
- **配置项**:
  - `api.log.enabled`: 是否启用API日志（默认：true）
  - `api.log.excludePackages`: 排除的包路径（逗号分隔）
  - `api.log.excludeClasses`: 排除的类名（逗号分隔）
  - `api.log.excludeMethods`: 排除的方法名（逗号分隔）

## 快速开始

### 1. 基本使用

无需任何配置，日志系统会自动拦截所有Controller方法：

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/info")
    public Result<UserInfo> getUserInfo() {
        // 业务逻辑
        return Result.success(userInfo);
    }
}
```

日志输出示例：
```
API调用 | UserController.getUserInfo | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | 方法: GET | 客户端: 127.0.0.1 | 状态: 成功 | 耗时: 45ms
```

### 2. 使用@ApiLog注解

如果需要自定义接口描述，可以使用`@ApiLog`注解：

```java
@ApiLog("获取用户信息")
@GetMapping("/info")
public Result<UserInfo> getUserInfo() {
    // 业务逻辑
    return Result.success(userInfo);
}
```

日志输出示例：
```
API调用 | 获取用户信息 | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | 方法: GET | 客户端: 127.0.0.1 | 状态: 成功 | 耗时: 45ms
```

### 3. 异常日志记录

当接口抛出异常时，系统会自动记录异常信息：

```java
@GetMapping("/info")
public Result<UserInfo> getUserInfo() {
    if (userNotFound) {
        throw new BusinessException("用户不存在");
    }
    return Result.success(userInfo);
}
```

异常日志输出示例：
```
API异常 | UserController.getUserInfo | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | 方法: GET | 客户端: 127.0.0.1 | 异常: 用户不存在 | 耗时: 12ms
```

## 配置说明

### 配置文件示例

在`application.yml`中配置：

```yaml
api:
  log:
    enabled: true  # 是否启用API日志
    exclude-packages: "com.dailydiscover.user.controller.internal"  # 排除的包路径
    exclude-classes: "HealthCheckController"  # 排除的类名
    exclude-methods: "healthCheck"  # 排除的方法名
```

### 配置项详解

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `api.log.enabled` | boolean | true | 是否启用API日志功能 |
| `api.log.excludePackages` | String | "" | 需要排除的包路径，多个用逗号分隔 |
| `api.log.excludeClasses` | String | "" | 需要排除的类名，多个用逗号分隔 |
| `api.log.excludeMethods` | String | "" | 需要排除的方法名，多个用逗号分隔 |

## 日志格式说明

### 成功日志格式
```
API调用 | [接口描述] | [时间戳] | URL: [请求URL] | 方法: [HTTP方法] | 客户端: [客户端IP] | 状态: 成功 | 耗时: [耗时]ms
```

### 异常日志格式
```
API异常 | [接口描述] | [时间戳] | URL: [请求URL] | 方法: [HTTP方法] | 客户端: [客户端IP] | 异常: [异常信息] | 耗时: [耗时]ms
```

## 高级用法

### 1. 自定义排除规则

通过配置文件灵活控制日志记录范围：

```yaml
api:
  log:
    enabled: true
    exclude-packages: "com.dailydiscover.internal,com.dailydiscover.monitor"
    exclude-classes: "HealthController,MonitorController"
    exclude-methods: "ping,health"
```

### 2. 客户端IP获取

系统会自动从以下HTTP头中获取客户端真实IP：
- `X-Forwarded-For`
- `Proxy-Client-IP`
- `WL-Proxy-Client-IP`
- `HTTP_CLIENT_IP`
- `HTTP_X_FORWARDED_FOR`

如果以上头信息不存在，则使用`request.getRemoteAddr()`获取IP。

## 最佳实践

### 1. 合理使用排除配置

对于频繁调用或不需要监控的接口，建议使用排除配置：

```yaml
api:
  log:
    exclude-methods: "healthCheck,metrics,prometheus"
```

### 2. 为重要接口添加描述

使用`@ApiLog`注解为重要业务接口添加清晰的描述：

```java
@ApiLog("用户登录认证")
@PostMapping("/login")
public Result<LoginResponse> login(@RequestBody LoginRequest request) {
    // 登录逻辑
}
```

### 3. 监控性能指标

通过日志中的耗时信息监控接口性能：
- 正常耗时：< 100ms
- 警告耗时：100ms - 500ms  
- 异常耗时：> 500ms

## 故障排除

### 1. 日志不输出

检查以下配置：
1. `api.log.enabled`是否为true
2. 方法是否在排除列表中
3. 方法是否在Controller包路径下

### 2. IP地址显示不正确

检查反向代理配置是否正确设置了`X-Forwarded-For`头。

### 3. 性能影响

如果发现日志记录影响性能，可以考虑：
1. 排除高频调用的接口
2. 使用异步日志记录（需要额外配置）

## 版本历史

### v1.0 (简化版)
- ✅ 统一日志格式
- ✅ 简化配置项
- ✅ 移除复杂依赖
- ✅ 保留核心功能

## 相关文件

- `ApiLogger.java` - 核心日志记录器
- `ApiLogAspect.java` - AOP切面实现
- `ApiLogConfig.java` - 配置类
- `ApiLog.java` - 自定义注解

---

*最后更新: 2024-12-25*