# æ—¥å¿—ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

é‡æ„åçš„æ—¥å¿—ç³»ç»Ÿé‡‡ç”¨èŒè´£åˆ†ç¦»è®¾è®¡ï¼Œæä¾›ä¸¤ä¸ªç‹¬ç«‹çš„æ—¥å¿—ç»„ä»¶ï¼š
- **ApiLogger**: ä¸“æ³¨äºHTTPåè®®å±‚é¢çš„APIè°ƒç”¨æ—¥å¿—è®°å½•
- **LogTracer**: ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å±‚é¢çš„æ–¹æ³•è°ƒç”¨å’Œæ“ä½œè¿½è¸ª

## æ ¸å¿ƒç»„ä»¶

### 1. ApiLogger (HTTPå±‚é¢æ—¥å¿—è®°å½•å™¨)
- **ä½ç½®**: `com.dailydiscover.common.util.ApiLogger`
- **èŒè´£**: HTTPåè®®å±‚é¢çš„æ—¥å¿—è®°å½•
- **ç‰¹æ€§**:
  - ç»Ÿä¸€çš„HTTPæ—¥å¿—æ ¼å¼ï¼š`ğŸŒ HTTP APIè°ƒç”¨ | æ¥å£æè¿° | æ—¶é—´æˆ³ | URL | æ–¹æ³• | å®¢æˆ·ç«¯ | çŠ¶æ€ç  | çŠ¶æ€ | å“åº” | è€—æ—¶`
  - æ”¯æŒæˆåŠŸå’Œå¼‚å¸¸ä¸¤ç§æ—¥å¿—ç±»å‹
  - è‡ªåŠ¨è·å–å®¢æˆ·ç«¯IPåœ°å€å’ŒHTTPçŠ¶æ€ç 
  - ç®€åŒ–ç‰ˆå“åº”å†…å®¹è®°å½•ï¼ˆé™åˆ¶é•¿åº¦ï¼‰

### 2. LogTracer (ä¸šåŠ¡å±‚é¢æ—¥å¿—è¿½è¸ªå™¨)
- **ä½ç½®**: `com.dailydiscover.common.util.LogTracer`
- **èŒè´£**: ä¸šåŠ¡é€»è¾‘å±‚é¢çš„æ—¥å¿—è¿½è¸ª
- **ç‰¹æ€§**:
  - ä¸šåŠ¡æ–¹æ³•è¿½è¸ªï¼š`ğŸ“‹ ä¸šåŠ¡æ–¹æ³•è¿½è¸ª | ä½ç½® | æ–¹æ³• | å…¥å‚ | å‡ºå‚`
  - æ•°æ®åº“æŸ¥è¯¢è¿½è¸ªï¼š`ğŸ—ƒï¸ æ•°æ®åº“æŸ¥è¯¢ | ä½ç½® | SQL | å‚æ•° | ç»“æœ`
  - ä¸šåŠ¡APIè°ƒç”¨è¿½è¸ªï¼š`ğŸ’¼ ä¸šåŠ¡APIè°ƒç”¨ | ä½ç½® | API | æ•°æ®`
  - ä¸šåŠ¡æ“ä½œè¿½è¸ªï¼š`ğŸ’¼ ä¸šåŠ¡æ“ä½œ | ä½ç½® | æ“ä½œ | è¯¦æƒ…`
  - ä¸šåŠ¡å¼‚å¸¸è¿½è¸ªï¼š`âŒ ä¸šåŠ¡å¼‚å¸¸è¿½è¸ª | ä½ç½® | å¼‚å¸¸ç±»å‹ | å¼‚å¸¸ä¿¡æ¯`
  - ä¸šåŠ¡æ€§èƒ½è¿½è¸ªï¼š`â±ï¸ ä¸šåŠ¡æ€§èƒ½è¿½è¸ª | ä½ç½® | æ“ä½œ | è€—æ—¶ | çº§åˆ«`

### 3. ApiLogAspect (AOPåˆ‡é¢)
- **ä½ç½®**: `com.dailydiscover.common.aspect.ApiLogAspect`
- **åŠŸèƒ½**: è‡ªåŠ¨æ‹¦æˆªControlleræ–¹æ³•å¹¶è®°å½•HTTPå±‚é¢æ—¥å¿—
- **æ‹¦æˆªèŒƒå›´**:
  - æ‰€æœ‰æ ‡è®°äº†`@ApiLog`æ³¨è§£çš„æ–¹æ³•
  - æ‰€æœ‰ControlleråŒ…ä¸‹çš„æ–¹æ³•ï¼ˆ`com.dailydiscover..controller..*.*(..)`ï¼‰

### 4. ApiLogConfig (é…ç½®ç±»)
- **ä½ç½®**: `com.dailydiscover.common.config.ApiLogConfig`
- **åŠŸèƒ½**: æä¾›çµæ´»çš„æ—¥å¿—é…ç½®é€‰é¡¹
- **é…ç½®é¡¹**:
  - `api.log.enabled`: æ˜¯å¦å¯ç”¨APIæ—¥å¿—ï¼ˆé»˜è®¤ï¼štrueï¼‰
  - `api.log.excludePackages`: æ’é™¤çš„åŒ…è·¯å¾„ï¼ˆé€—å·åˆ†éš”ï¼‰
  - `api.log.excludeClasses`: æ’é™¤çš„ç±»åï¼ˆé€—å·åˆ†éš”ï¼‰
  - `api.log.excludeMethods`: æ’é™¤çš„æ–¹æ³•åï¼ˆé€—å·åˆ†éš”ï¼‰

## å¿«é€Ÿå¼€å§‹

### 1. HTTPå±‚é¢æ—¥å¿—ï¼ˆè‡ªåŠ¨è®°å½•ï¼‰

æ— éœ€ä»»ä½•é…ç½®ï¼ŒApiLoggerä¼šè‡ªåŠ¨æ‹¦æˆªæ‰€æœ‰Controlleræ–¹æ³•è®°å½•HTTPå±‚é¢ä¿¡æ¯ï¼š

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/info")
    public Result<UserInfo> getUserInfo() {
        // ä¸šåŠ¡é€»è¾‘
        return Result.success(userInfo);
    }
}
```

HTTPæ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸŒ HTTP APIè°ƒç”¨ | UserController.getUserInfo | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | æ–¹æ³•: GET | å®¢æˆ·ç«¯: 127.0.0.1 | çŠ¶æ€ç : 200 | çŠ¶æ€: æˆåŠŸ | å“åº”: Result{code=0, data=UserInfo{...}, message=null} | è€—æ—¶: 45ms
```

### 2. ä¸šåŠ¡å±‚é¢æ—¥å¿—ï¼ˆæ‰‹åŠ¨è°ƒç”¨ï¼‰

åœ¨ä¸šåŠ¡æ–¹æ³•ä¸­ä½¿ç”¨LogTracerè®°å½•ä¸šåŠ¡å±‚é¢çš„è¯¦ç»†ä¿¡æ¯ï¼š

```java
@Service
public class UserService {
    
    public UserInfo getUserInfo(Long userId) {
        long startTime = System.currentTimeMillis();
        
        // è®°å½•ä¸šåŠ¡æ–¹æ³•è°ƒç”¨
        LogTracer.traceBusinessMethod("getUserInfo", userId, null);
        
        try {
            // æ•°æ®åº“æŸ¥è¯¢
            UserInfo user = userRepository.findById(userId);
            LogTracer.traceDatabaseQuery("SELECT * FROM users WHERE id = ?", userId, user);
            
            // è®°å½•ä¸šåŠ¡æ“ä½œ
            LogTracer.traceBusinessOperation("è·å–ç”¨æˆ·ä¿¡æ¯", user);
            
            // è®°å½•æ€§èƒ½
            LogTracer.traceBusinessPerformance("è·å–ç”¨æˆ·ä¿¡æ¯", startTime);
            
            return user;
        } catch (Exception e) {
            // è®°å½•ä¸šåŠ¡å¼‚å¸¸
            LogTracer.traceBusinessException(e);
            throw e;
        }
    }
}
```

ä¸šåŠ¡æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ“‹ ä¸šåŠ¡æ–¹æ³•è¿½è¸ª | ä½ç½®: com.dailydiscover.service.UserService.getUserInfo(UserService.java:25) | æ–¹æ³•: getUserInfo | å…¥å‚: 123 | å‡ºå‚: UserInfo{...}
ğŸ—ƒï¸  æ•°æ®åº“æŸ¥è¯¢ | ä½ç½®: com.dailydiscover.service.UserService.getUserInfo(UserService.java:30) | SQL: SELECT * FROM users WHERE id = ? | å‚æ•°: 123 | ç»“æœ: UserInfo{...}
ğŸ’¼ ä¸šåŠ¡æ“ä½œ | ä½ç½®: com.dailydiscover.service.UserService.getUserInfo(UserService.java:33) | æ“ä½œ: è·å–ç”¨æˆ·ä¿¡æ¯ | è¯¦æƒ…: UserInfo{...}
â±ï¸  ä¸šåŠ¡æ€§èƒ½è¿½è¸ª | ä½ç½®: com.dailydiscover.service.UserService.getUserInfo(UserService.java:36) | æ“ä½œ: è·å–ç”¨æˆ·ä¿¡æ¯ | è€—æ—¶: 45ms | çº§åˆ«: âš¡ å¿«é€Ÿ
```

### 3. ä½¿ç”¨@ApiLogæ³¨è§£è‡ªå®šä¹‰HTTPæ—¥å¿—æè¿°

```java
@ApiLog("è·å–ç”¨æˆ·ä¿¡æ¯")
@GetMapping("/info")
public Result<UserInfo> getUserInfo() {
    // ä¸šåŠ¡é€»è¾‘
    return Result.success(userInfo);
}
```

è‡ªå®šä¹‰HTTPæ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸŒ HTTP APIè°ƒç”¨ | è·å–ç”¨æˆ·ä¿¡æ¯ | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | æ–¹æ³•: GET | å®¢æˆ·ç«¯: 127.0.0.1 | çŠ¶æ€ç : 200 | çŠ¶æ€: æˆåŠŸ | å“åº”: Result{code=0, data=UserInfo{...}, message=null} | è€—æ—¶: 45ms
```

### 4. å¼‚å¸¸æ—¥å¿—è®°å½•

å½“æ¥å£æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•HTTPå±‚é¢å¼‚å¸¸ä¿¡æ¯ï¼š

```java
@GetMapping("/info")
public Result<UserInfo> getUserInfo() {
    if (userNotFound) {
        throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    return Result.success(userInfo);
}
```

HTTPå¼‚å¸¸æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
```
âŒ HTTP APIå¼‚å¸¸ | UserController.getUserInfo | 2024-12-25 10:30:15 | URL: http://localhost:8080/api/user/info | æ–¹æ³•: GET | å®¢æˆ·ç«¯: 127.0.0.1 | å¼‚å¸¸: ç”¨æˆ·ä¸å­˜åœ¨ | è€—æ—¶: 12ms
```

## é…ç½®è¯´æ˜

### 1. æ—¥å¿—çº§åˆ«é…ç½®

åœ¨`application.yml`ä¸­é…ç½®ä¸åŒç»„ä»¶çš„æ—¥å¿—çº§åˆ«ï¼š

```yaml
logging:
  level:
    # HTTPå±‚é¢æ—¥å¿—ç»„ä»¶
    com.dailydiscover.common.util.ApiLogger: INFO
    com.dailydiscover.common.aspect.ApiLogAspect: INFO
    
    # ä¸šåŠ¡å±‚é¢æ—¥å¿—ç»„ä»¶
    com.dailydiscover.common.util.LogTracer: INFO
```

### 2. è‡ªå®šä¹‰é…ç½®

åœ¨`application.yml`ä¸­é…ç½®HTTPæ—¥å¿—ç›¸å…³å‚æ•°ï¼š

```yaml
daily-discover:
  api-log:
    # æ˜¯å¦å¯ç”¨HTTP APIæ—¥å¿—ï¼ˆé»˜è®¤ï¼štrueï¼‰
    enabled: true
    # æ˜¯å¦è®°å½•HTTPè¯·æ±‚å‚æ•°ï¼ˆé»˜è®¤ï¼štrueï¼‰
    log-request: true
    # æ˜¯å¦è®°å½•HTTPå“åº”å†…å®¹ï¼ˆé»˜è®¤ï¼štrueï¼‰
    log-response: true
    # HTTPå“åº”å†…å®¹æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤ï¼š1000ï¼‰
    max-response-length: 1000
    # æ˜¯å¦è®°å½•HTTPå¼‚å¸¸å †æ ˆï¼ˆé»˜è®¤ï¼štrueï¼‰
    log-exception-stack: true
```

### 3. LogTraceré…ç½®

LogTraceræ— éœ€é¢å¤–é…ç½®ï¼Œç›´æ¥é€šè¿‡æ–¹æ³•è°ƒç”¨å³å¯ä½¿ç”¨ã€‚æ”¯æŒä»¥ä¸‹é…ç½®é¡¹ï¼ˆé€šè¿‡æ–¹æ³•å‚æ•°æ§åˆ¶ï¼‰ï¼š

- **æ€§èƒ½çº§åˆ«é˜ˆå€¼**ï¼šé€šè¿‡`traceBusinessPerformance`æ–¹æ³•çš„æ€§èƒ½çº§åˆ«åˆ¤æ–­
- **æ—¥å¿—è¯¦ç»†ç¨‹åº¦**ï¼šé€šè¿‡æ˜¯å¦è°ƒç”¨ç›¸åº”æ–¹æ³•æ§åˆ¶
- **å¼‚å¸¸è®°å½•æ·±åº¦**ï¼šé€šè¿‡`traceBusinessException`æ–¹æ³•å‚æ•°æ§åˆ¶

### 4. æ’é™¤é…ç½®ç¤ºä¾‹

åœ¨`application.yml`ä¸­é…ç½®ï¼š

```yaml
api:
  log:
    enabled: true  # æ˜¯å¦å¯ç”¨APIæ—¥å¿—
    exclude-packages: "com.dailydiscover.user.controller.internal"  # æ’é™¤çš„åŒ…è·¯å¾„
    exclude-classes: "HealthCheckController"  # æ’é™¤çš„ç±»å
    exclude-methods: "healthCheck"  # æ’é™¤çš„æ–¹æ³•å
```

### é…ç½®é¡¹è¯¦è§£

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `api.log.enabled` | boolean | true | æ˜¯å¦å¯ç”¨APIæ—¥å¿—åŠŸèƒ½ |
| `api.log.excludePackages` | String | "" | éœ€è¦æ’é™¤çš„åŒ…è·¯å¾„ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš” |
| `api.log.excludeClasses` | String | "" | éœ€è¦æ’é™¤çš„ç±»åï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš” |
| `api.log.excludeMethods` | String | "" | éœ€è¦æ’é™¤çš„æ–¹æ³•åï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš” |

## æ—¥å¿—æ ¼å¼è¯´æ˜

### 1. HTTPå±‚é¢æ—¥å¿—æ ¼å¼ï¼ˆApiLoggerï¼‰

#### æ­£å¸¸HTTPè¯·æ±‚æ—¥å¿—æ ¼å¼
```
ğŸŒ HTTP APIè°ƒç”¨ | [æ¥å£æè¿°] | [æ—¶é—´] | URL: [è¯·æ±‚URL] | æ–¹æ³•: [HTTPæ–¹æ³•] | å®¢æˆ·ç«¯: [å®¢æˆ·ç«¯IP] | çŠ¶æ€ç : [HTTPçŠ¶æ€ç ] | çŠ¶æ€: [æˆåŠŸ/å¤±è´¥] | å“åº”: [å“åº”å†…å®¹] | è€—æ—¶: [è€—æ—¶ms]
```

#### HTTPå¼‚å¸¸è¯·æ±‚æ—¥å¿—æ ¼å¼
```
âŒ HTTP APIå¼‚å¸¸ | [æ¥å£æè¿°] | [æ—¶é—´] | URL: [è¯·æ±‚URL] | æ–¹æ³•: [HTTPæ–¹æ³•] | å®¢æˆ·ç«¯: [å®¢æˆ·ç«¯IP] | å¼‚å¸¸: [å¼‚å¸¸ä¿¡æ¯] | è€—æ—¶: [è€—æ—¶ms]
```

### 2. ä¸šåŠ¡å±‚é¢æ—¥å¿—æ ¼å¼ï¼ˆLogTracerï¼‰

#### ä¸šåŠ¡æ–¹æ³•è¿½è¸ªæ—¥å¿—æ ¼å¼
```
ğŸ“‹ ä¸šåŠ¡æ–¹æ³•è¿½è¸ª | ä½ç½®: [æ–¹æ³•ä½ç½®] | æ–¹æ³•: [æ–¹æ³•å] | å…¥å‚: [å…¥å‚è¯¦æƒ…] | å‡ºå‚: [å‡ºå‚è¯¦æƒ…]
```

#### æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—æ ¼å¼
```
ğŸ—ƒï¸  æ•°æ®åº“æŸ¥è¯¢ | ä½ç½®: [æ–¹æ³•ä½ç½®] | SQL: [SQLè¯­å¥] | å‚æ•°: [å‚æ•°è¯¦æƒ…] | ç»“æœ: [æŸ¥è¯¢ç»“æœ]
```

#### ä¸šåŠ¡æ“ä½œæ—¥å¿—æ ¼å¼
```
ğŸ’¼ ä¸šåŠ¡æ“ä½œ | ä½ç½®: [æ–¹æ³•ä½ç½®] | æ“ä½œ: [æ“ä½œæè¿°] | è¯¦æƒ…: [æ“ä½œè¯¦æƒ…]
```

#### ä¸šåŠ¡å¼‚å¸¸æ—¥å¿—æ ¼å¼
```
ğŸš¨ ä¸šåŠ¡å¼‚å¸¸ | ä½ç½®: [æ–¹æ³•ä½ç½®] | å¼‚å¸¸: [å¼‚å¸¸ä¿¡æ¯] | å †æ ˆ: [å¼‚å¸¸å †æ ˆ]
```

#### ä¸šåŠ¡æ€§èƒ½è¿½è¸ªæ—¥å¿—æ ¼å¼
```
â±ï¸  ä¸šåŠ¡æ€§èƒ½è¿½è¸ª | ä½ç½®: [æ–¹æ³•ä½ç½®] | æ“ä½œ: [æ“ä½œæè¿°] | è€—æ—¶: [è€—æ—¶ms] | çº§åˆ«: [âš¡ å¿«é€Ÿ/ğŸ¢ æ­£å¸¸/ğŸŒ ç¼“æ…¢]
```

### 3. æ—¥å¿—æ ¼å¼ç‰¹ç‚¹

- **è¡¨æƒ…ç¬¦å·æ ‡è¯†**ï¼šæ¯ä¸ªæ—¥å¿—ç±»å‹éƒ½æœ‰ç‹¬ç‰¹çš„è¡¨æƒ…ç¬¦å·ï¼Œä¾¿äºå¿«é€Ÿè¯†åˆ«
- **ç»“æ„åŒ–ä¿¡æ¯**ï¼šä½¿ç”¨ç«–çº¿åˆ†éš”ä¸åŒä¿¡æ¯æ®µï¼Œä¾¿äºæ—¥å¿—è§£æ
- **ä½ç½®ä¿¡æ¯**ï¼šåŒ…å«å®Œæ•´çš„ç±»åã€æ–¹æ³•åå’Œè¡Œå·ä¿¡æ¯
- **æ€§èƒ½åˆ†çº§**ï¼šæ€§èƒ½æ—¥å¿—è‡ªåŠ¨åˆ†çº§ï¼Œä¾¿äºæ€§èƒ½ç›‘æ§

## é«˜çº§ç”¨æ³•

### 1. HTTPå±‚é¢æ—¥å¿—é«˜çº§ç”¨æ³•

#### è‡ªå®šä¹‰HTTPæ—¥å¿—å¤„ç†å™¨

å¯ä»¥ç»§æ‰¿`ApiLogger`å¹¶é‡å†™ç›¸å…³æ–¹æ³•æ¥è‡ªå®šä¹‰HTTPæ—¥å¿—å¤„ç†é€»è¾‘ï¼š

```java
@Component
public class CustomApiLogger extends ApiLogger {
    
    @Override
    public void logHttpApiCall(String apiDescription, String url, String method, 
                              String clientIp, int statusCode, Object response, long executionTime) {
        // è‡ªå®šä¹‰HTTPæ—¥å¿—å¤„ç†é€»è¾‘
        super.logHttpApiCall(apiDescription, url, method, clientIp, statusCode, response, executionTime);
        
        // å‘é€åˆ°HTTPç›‘æ§ç³»ç»Ÿ
        sendToHttpMonitoringSystem(apiDescription, statusCode, executionTime);
    }
}
```

#### HTTPå¼‚æ­¥æ—¥å¿—å¤„ç†

å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥é…ç½®HTTPå¼‚æ­¥æ—¥å¿—å¤„ç†ï¼š

```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean("httpApiLogExecutor")
    public Executor httpApiLogExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("http-api-log-");
        executor.initialize();
        return executor;
    }
}
```

### 2. ä¸šåŠ¡å±‚é¢æ—¥å¿—é«˜çº§ç”¨æ³•

#### ä¸šåŠ¡æ—¥å¿—ä¸Šä¸‹æ–‡ç®¡ç†

ä½¿ç”¨`ThreadLocal`ç®¡ç†ä¸šåŠ¡æ—¥å¿—ä¸Šä¸‹æ–‡ï¼Œå®ç°è·¨æ–¹æ³•è°ƒç”¨é“¾è¿½è¸ªï¼š

```java
@Service
public class OrderService {
    
    public void createOrder(OrderRequest request) {
        // å¼€å§‹ä¸šåŠ¡è¿½è¸ª
        LogTracer.traceBusinessMethod("createOrder", request, null);
        
        try {
            // éªŒè¯ç”¨æˆ·
            validateUser(request.getUserId());
            
            // æ£€æŸ¥åº“å­˜
            checkInventory(request.getItems());
            
            // åˆ›å»ºè®¢å•
            Order order = createOrderInternal(request);
            
            // è®°å½•ä¸šåŠ¡æ“ä½œ
            LogTracer.traceBusinessOperation("åˆ›å»ºè®¢å•æˆåŠŸ", order);
            
        } catch (Exception e) {
            // è®°å½•ä¸šåŠ¡å¼‚å¸¸
            LogTracer.traceBusinessException(e);
            throw e;
        }
    }
    
    private void validateUser(Long userId) {
        LogTracer.traceBusinessMethod("validateUser", userId, null);
        // éªŒè¯é€»è¾‘
    }
    
    private void checkInventory(List<OrderItem> items) {
        LogTracer.traceBusinessMethod("checkInventory", items, null);
        // åº“å­˜æ£€æŸ¥é€»è¾‘
    }
}
```

#### ä¸šåŠ¡æ€§èƒ½ç›‘æ§é›†æˆ

å°†LogTracerä¸æ€§èƒ½ç›‘æ§ç³»ç»Ÿé›†æˆï¼š

```java
@Service
public class PerformanceMonitoringService {
    
    public void monitorBusinessPerformance(String operation, long startTime) {
        long executionTime = System.currentTimeMillis() - startTime;
        
        // è®°å½•ä¸šåŠ¡æ€§èƒ½
        LogTracer.traceBusinessPerformance(operation, startTime);
        
        // å‘é€åˆ°æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
        sendToPerformanceSystem(operation, executionTime);
    }
}
```

### 3. æ—¥å¿—è¿‡æ»¤

å¯ä»¥é€šè¿‡é…ç½®æ’é™¤æŸäº›HTTPæ¥å£çš„æ—¥å¿—è®°å½•ï¼š

```yaml
daily-discover:
  api-log:
    exclude-patterns:
      - /actuator/**
      - /health/**
      - /swagger-ui/**
```

### 4. è‡ªå®šä¹‰æ’é™¤è§„åˆ™

é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»æ§åˆ¶æ—¥å¿—è®°å½•èŒƒå›´ï¼š

```yaml
api:
  log:
    enabled: true
    exclude-packages: "com.dailydiscover.internal,com.dailydiscover.monitor"
    exclude-classes: "HealthController,MonitorController"
    exclude-methods: "ping,health"
```

### 5. å®¢æˆ·ç«¯IPè·å–

ç³»ç»Ÿä¼šè‡ªåŠ¨ä»ä»¥ä¸‹HTTPå¤´ä¸­è·å–å®¢æˆ·ç«¯çœŸå®IPï¼š
- `X-Forwarded-For`
- `Proxy-Client-IP`
- `WL-Proxy-Client-IP`
- `HTTP_CLIENT_IP`
- `HTTP_X_FORWARDED_FOR`

å¦‚æœä»¥ä¸Šå¤´ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨`request.getRemoteAddr()`è·å–IPã€‚

## æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨æ’é™¤é…ç½®

å¯¹äºé¢‘ç¹è°ƒç”¨æˆ–ä¸éœ€è¦ç›‘æ§çš„æ¥å£ï¼Œå»ºè®®ä½¿ç”¨æ’é™¤é…ç½®ï¼š

```yaml
api:
  log:
    exclude-methods: "healthCheck,metrics,prometheus"
```

### 2. ä¸ºé‡è¦æ¥å£æ·»åŠ æè¿°

ä½¿ç”¨`@ApiLog`æ³¨è§£ä¸ºé‡è¦ä¸šåŠ¡æ¥å£æ·»åŠ æ¸…æ™°çš„æè¿°ï¼š

```java
@ApiLog("ç”¨æˆ·ç™»å½•è®¤è¯")
@PostMapping("/login")
public Result<LoginResponse> login(@RequestBody LoginRequest request) {
    // ç™»å½•é€»è¾‘
}
```

### 3. ç›‘æ§æ€§èƒ½æŒ‡æ ‡

é€šè¿‡æ—¥å¿—ä¸­çš„è€—æ—¶ä¿¡æ¯ç›‘æ§æ¥å£æ€§èƒ½ï¼š
- æ­£å¸¸è€—æ—¶ï¼š< 100ms
- è­¦å‘Šè€—æ—¶ï¼š100ms - 500ms  
- å¼‚å¸¸è€—æ—¶ï¼š> 500ms

## æ•…éšœæ’é™¤

### 1. æ—¥å¿—ä¸è¾“å‡º

æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š
1. `api.log.enabled`æ˜¯å¦ä¸ºtrue
2. æ–¹æ³•æ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨ä¸­
3. æ–¹æ³•æ˜¯å¦åœ¨ControlleråŒ…è·¯å¾„ä¸‹

### 2. IPåœ°å€æ˜¾ç¤ºä¸æ­£ç¡®

æ£€æŸ¥åå‘ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®è®¾ç½®äº†`X-Forwarded-For`å¤´ã€‚

### 3. æ€§èƒ½å½±å“

å¦‚æœå‘ç°æ—¥å¿—è®°å½•å½±å“æ€§èƒ½ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. æ’é™¤é«˜é¢‘è°ƒç”¨çš„æ¥å£
2. ä½¿ç”¨å¼‚æ­¥æ—¥å¿—è®°å½•ï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰

## ç‰ˆæœ¬å†å²

### v1.0 (ç®€åŒ–ç‰ˆ)
- âœ… ç»Ÿä¸€æ—¥å¿—æ ¼å¼
- âœ… ç®€åŒ–é…ç½®é¡¹
- âœ… ç§»é™¤å¤æ‚ä¾èµ–
- âœ… ä¿ç•™æ ¸å¿ƒåŠŸèƒ½

## ç›¸å…³æ–‡ä»¶

- `ApiLogger.java` - æ ¸å¿ƒæ—¥å¿—è®°å½•å™¨
- `ApiLogAspect.java` - AOPåˆ‡é¢å®ç°
- `ApiLogConfig.java` - é…ç½®ç±»
- `ApiLog.java` - è‡ªå®šä¹‰æ³¨è§£

---

*æœ€åæ›´æ–°: 2024-12-25*