# 统一安全配置模块技术文档

## 模块概述

统一安全配置模块是微服务架构中的核心安全组件，为所有业务服务提供标准化的安全配置框架。该模块基于Spring Security构建，实现了统一的安全策略管理和权限控制。

## 核心组件

### SimpleSecurityConfig - 统一安全配置类

#### 设计理念
- **统一管理**：所有业务服务共享同一套安全配置基础
- **灵活扩展**：支持业务服务根据需求进行定制化配置
- **标准化**：确保系统安全策略的一致性
- **可复用**：提供基础安全配置方法供子类复用

#### 主要特性

1. **基础安全配置方法**
   ```java
   protected HttpSecurity configureBaseSecurity(HttpSecurity http)
   ```
   - CSRF防护禁用
   - 默认认证方式禁用
   - 供子类复用的基础配置

2. **权限控制策略**
   - **系统级公开接口**：监控端点、API文档等
   - **业务公开接口**：首页内容、商品浏览等无需认证的接口
   - **默认认证要求**：其他接口统一要求身份验证

3. **继承扩展机制**
   - 子类可以复用基础安全配置
   - 支持业务特定的权限规则定制
   - 避免配置代码重复

### JwtUtil - 通用JWT工具类

#### 设计理念
- **统一验证**：所有微服务使用相同的Token验证标准
- **业务无关**：专注于Token的验证和解析，不涉及具体业务逻辑
- **可复用**：任何需要验证JWT Token的服务都可以直接使用
- **职责分离**：认证中心负责颁发Token，所有服务负责验证Token

#### 主要功能

1. **Token验证**
   ```java
   public Boolean validateToken(String token)
   ```
   - 验证Token签名和过期时间
   - 统一的验证逻辑确保系统一致性
   - 所有服务可以独立验证Token，无需依赖用户服务

2. **用户信息解析**
   ```java
   public Long getUserIdFromToken(String token)
   public String getPhoneFromToken(String token)
   ```
   - 从Token中提取用户身份信息
   - 支持所有服务获取用户上下文
   - 实现服务间的身份信息传递

3. **Token生成（基础）**
   - 提供基础的Token生成能力
   - 用户服务可以基于此实现业务相关的Token生成
   - 确保Token格式和标准的统一性

### JwtAuthenticationFilter - 通用JWT认证过滤器

#### 设计理念
- **HTTP层集成**：与Spring Security过滤器链无缝集成
- **请求拦截**：拦截HTTP请求进行身份认证
- **上下文管理**：将认证信息设置到SecurityContext中
- **职责分离**：专注于HTTP层面的认证流程，与Token技术细节解耦

#### 主要功能

1. **请求拦截认证**
   ```java
   protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
   ```
   - 拦截所有HTTP请求
   - 提取Authorization头中的Bearer Token
   - 调用JwtUtil进行Token验证

2. **认证上下文管理**
   - 验证成功后创建UsernamePasswordAuthenticationToken
   - 设置用户角色和权限信息
   - 将认证信息存储到SecurityContext中

3. **异常处理**
   - 捕获Token验证异常
   - 清除失败的认证信息
   - 确保认证失败不影响后续请求处理

#### 权限配置详情

**公开访问接口分类：**

| 接口类型 | 路径示例 | 说明 |
|---------|---------|------|
| 系统监控 | `/actuator/health` | 健康检查端点 |
| API文档 | `/swagger-ui/**` | 接口文档页面 |
| 首页内容 | `/hot`, `/new` | 热门商品、新品展示 |
| 商品浏览 | `/{id}`, `/category/{id}` | 商品详情、分类浏览 |

## 架构设计

### 统一管理模式

所有业务服务通过继承`SimpleSecurityConfig`类使用统一的安全配置：

```java
@Configuration
public class UserServiceSecurityConfig extends SimpleSecurityConfig {
    // 无需重写安全配置，所有权限规则已在SimpleSecurityConfig中统一管理
    // 只需要配置业务特定的组件（如密码编码器）
}
```

### 职责分工

#### 公共服务（common）职责
**JwtUtil工具类：**
- ✅ Token验证（验签、过期检查）
- ✅ Token解析（获取用户ID、手机号等）
- ✅ Token生成（基础生成能力）
- ✅ 刷新Token管理

**JwtAuthenticationFilter过滤器：**
- ✅ HTTP请求拦截和Token提取
- ✅ 认证流程管理（成功/失败处理）
- ✅ SecurityContext认证信息设置
- ✅ 异常处理和上下文清理

**SimpleSecurityConfig配置类：**
- ✅ 安全配置框架（包含所有服务的权限规则）
- ✅ 公开接口权限管理
- ✅ CSRF防护配置

#### 用户服务（认证中心）职责
- ✅ 登录验证（用户名密码验证）
- ✅ 颁发Token（使用common的JWT工具）
- ✅ 用户身份管理
- ✅ 密码编码器配置（业务特定组件）
- ✅ 业务特定的JWT工具封装（UserJwtUtil）

#### 业务服务职责
- ✅ 使用common的JwtAuthenticationFilter进行请求认证
- ✅ 使用common的JwtUtil进行Token验证
- ✅ 继承SimpleSecurityConfig进行安全配置
- ✅ 实现业务特定的权限控制

### 配置层次结构

1. **基础层**：统一安全配置（本模块）
2. **业务层**：服务特定安全配置
3. **环境层**：不同环境的安全策略

## 技术实现

### 依赖管理

模块提供完整的安全相关依赖：
- Spring Security核心依赖
- JWT Token支持
- 密码加密工具

### 配置管理

通过Spring Boot的配置机制实现：
- 自动配置加载
- 环境特定配置支持
- 条件化配置启用

## 架构设计详解

### 1. 职责分离设计模式

#### JwtUtil与JwtAuthenticationFilter的分离
```
┌─────────────────┐    ┌─────────────────────────┐
│   JwtUtil       │    │ JwtAuthenticationFilter │
│                 │    │                         │
│ • Token验证     │◄───│ • HTTP请求拦截          │
│ • Token解析     │    │ • Token提取             │
│ • Token生成     │    │ • 认证流程管理          │
│ • 技术细节      │    │ • SecurityContext设置   │
└─────────────────┘    └─────────────────────────┘
```

**分离优势：**
- **单一职责**：每个类专注于特定领域
- **可测试性**：JwtUtil可独立单元测试，过滤器可集成测试
- **复用性**：JwtUtil可在非Web环境使用
- **维护性**：技术变更只影响JwtUtil，流程变更只影响过滤器

### 2. 组件协作流程

```
HTTP请求 → JwtAuthenticationFilter → JwtUtil → 认证结果
    ↓              ↓                    ↓           ↓
提取Token      调用验证方法          技术验证     设置上下文
```

### 3. 扩展性设计

#### 业务服务扩展模式
```java
// 业务服务可以基于通用组件进行扩展
@Component
public class CustomJwtUtil extends JwtUtil {
    // 添加业务特定的Token处理逻辑
}

@Configuration  
public class CustomSecurityConfig extends SimpleSecurityConfig {
    // 添加业务特定的安全规则
}
```

## 最佳实践

### 1. 安全配置原则
- **最小权限原则**：只开放必要的公开接口
- **防御性编程**：默认要求认证，显式配置公开接口
- **一致性**：所有服务使用统一的安全标准

### 2. 扩展建议
- 业务服务应优先使用基础配置
- 特殊需求通过重写方法实现
- 保持配置的简洁性和可维护性

### 3. 组件使用规范
- **JwtUtil使用**：直接注入使用，避免重复实现Token验证逻辑
- **过滤器使用**：通过Spring Security配置自动启用
- **配置继承**：优先继承SimpleSecurityConfig，避免配置重复

### 4. 安全考虑
- 定期审查公开接口列表
- 监控异常访问模式
- 及时更新安全依赖
- 定期轮换JWT密钥

## 使用示例

### 基础使用
```java
@Configuration
public class ProductServiceConfig extends SimpleSecurityConfig {
    // 自动继承基础安全配置
}
```

### 定制化配置
```java
@Configuration
public class AdminServiceConfig extends SimpleSecurityConfig {
    
    @Bean
    @Override
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return super.filterChain(http)
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/admin/**").hasRole("ADMIN")
            );
    }
}
```

## 总结

统一安全配置模块通过提供标准化的安全基础框架，实现了：

1. **配置统一化**：消除各服务间的安全配置差异
2. **维护简便化**：集中管理安全策略变更
3. **扩展灵活性**：支持业务特定需求的定制
4. **安全性保障**：基于行业最佳实践的安全配置

该模块是微服务架构中安全治理的重要基础设施，为系统的整体安全性提供了坚实基础。